# 量化研究计划-1001

基于microsoft-qlib的量化交易研究计划，结合vibe-coding逐步完成。此计划为人工编写，coding agent不应修改。[官方文档](https://qlib.readthedocs.io/en/latest/index.html) [官方仓库](https://github.com/microsoft/qlib/tree/main) 

coding agent在此仓库中编辑py代码时，应使用中文注释表明每一段函数/类的作用。

## 1. 标的与长期底仓清单

### 1.1 全量标的池
- **科技**: NVDA, TSM, AAPL, MSFT, GOOGL, AMZN, META, SAP, ANET, AVGO, IBM, TSLA, PLTR, ADP, ALAB, ADI, TXN, MU, QCOM, ARM
- **金融**: JPM, MS, KKR, MAIN, V, AXP, PGR, ICE, BN, SPGI, BX, NDAQ, ARES  
- **传统消费与工业**: ABBV, CAT, RTX, VST, MNST, MCD, CVX  

### 1.2 长期底仓规则
- **底仓清单**：从全量标的中预先指定 ≤15 只股票。  
- **底仓定义**：仅对该股票的**第一笔“从无到有”的建仓买入单**适用：  
  - 该笔买入单不做离场（不受止盈止损约束），作为长期底仓。  
  - 后续加仓买入单 → 按普通出场纪律处理。  
- 底仓清单可按季度/半年更新。

---

## 2. 数据获取
- 来源：Yahoo Finance 等免费接口  
- 频率：日线或 4 小时（取决于策略频率）  
- 字段：开盘、收盘、最高、最低、成交量（必要时加复权价、分红数据）

---

## 3. 特征工程（分组对比）
- **传统技术指标**  
  - 主图：EMA(5/10/20/60) 及斜率、BOLL、SAR、Keltner Channel(KC)  
  - 趋势：MACD、DMI、DMA、ADTM、DDI、DPO  
  - 超买超卖：CCI、KDJ、RSI、OSC  
  - 能量：ARBR、PSY、VR  
  - 摆动：ATR、Mass Index(MI)、SRMI  
- **二级信号**（仅标记当日）：MACD 金叉、KDJ 金叉、EMA 多头突破、SAR 翻转、DMI 金叉、ADTM 上穿、DDI/DPO 由负转正、OSC 上穿 DE、SRMI 由负转正等  
- **因子扩展**: Alpha360 等量化因子  

> **特征对比设计**：  
> - 单独使用：基础 / 二级 / 因子  
> - 组合使用：基础+二级、基础+因子、二级+因子、全量  
> - 在所有候选模型上进行矩阵实验。

---

## 4. 交易纪律（初始资金 $10,000）

> 参数（ATR 倍数、盈亏比、仓位比例等）均为初始设定，在研究中作为超参数可调。

### 4.1 中长线策略
1. **触发条件**  
   - 模型买入信号  
   - MA20 > MA60（确认趋势向上）  
   - 买入仓位：约 6%（上取整股数）  
2. **固定止盈止损（单笔级别）**  
   - 止损线 = 买入价 − 2 × ATR  
   - 止盈线 = 买入价 + 3 × ATR（盈亏比约 1.5:1）  
   - 规则：  
     - 跌破止损 → 平掉该笔仓位  
     - 到达止盈 → 卖出该笔一半仓位，其余进入移动止盈  
3. **移动止盈**  
   - 止损线每日更新为：  
     `max(买入后最高点 − 2 × ATR, 当前 MA20)`  
   - 止损线只会上移，不下移  
   - 若价格跌破止损线 → 平掉该笔剩余仓位  

### 4.2 短线策略
1. 若当日已有中长线操作 → 当日不做短线  
2. **触发条件**：短线模型买入信号  
3. **仓位**：约 4%（上取整股数）  
4. **固定止盈止损（单笔级别）**  
   - 止损线 = 买入价 − 1 × ATR  
   - 止盈线 = 买入价 + 1.5 × ATR（盈亏比约 1.5:1）  
   - 规则：触发止损或止盈即平仓该单  

### 4.3 组合层面约束
- **底仓优先级**：  
  - 首笔建仓单在底仓清单内 → 长期持有，不离场  
  - 其他加仓单 → 遵循普通出场纪律  
- **单股票仓位上限**：≤20% 总资产  
- **资金不足时**：若多标的触发买入 → 按信号“胜率概率”从高到低分配资金  

---

## 5. 标签定义与交易信号

### 5.1 标签定义
- 以中长线为例
- **胜**：买入后 15 日内先触发止盈（短线为 5 日）  
- **负**：买入后 15 日内先触发止损（短线为 5 日）  
- **平**：观察窗口内未触发止盈或止损  
- **第x日开盘买入 vs 第x-1日收盘买入**：  
  - 同时计算两种买入方式  
  - 取最坏结果：胜&平=平；平&负=负；胜&负=负  
- 短线标签：观察窗口为 5 日，对应止盈 +1.5 × ATR、止损 −1 × ATR  

### 5.2 信号定义方案
- 方案 A：预测结果 = 胜 → 买入  
- 方案 B：预测结果 = 胜 且 P(胜) > 0.5 → 买入  
- 后续研究比较两方案，择优使用  

---

## 6. 候选模型
- Transformer  
- iTransformer  
- PatchTST  
- TimesNet  
- Mamba2  
- TimeMixer  

---

## 7. 验证与回测方法
1. **时间滚动切分**  
   - 训练集：前 3 年  
   - 验证集：第 4 年  
   - 测试集：第 5 年  
   - 窗口滚动推进，形成多组样本  
2. **行业分组验证**  
   - 分科技/金融/传统消费工业，对比跨行业鲁棒性  
3. **预测指标**  
   - Accuracy, F1（应对类别不均衡）  
   - 信息系数 IC, Rank-IC  
4. **交易回测指标**  
   - 年化收益率  
   - 夏普比率  
   - 最大回撤  
   - 胜率  
   - 换手率与交易频次  
   - 成本敏感性（佣金、滑点、点差）  
5. **鲁棒性与压力测试**  
   - 参数敏感性：ATR 倍数、仓位比例、盈亏比  
   - 市场环境：牛市、熊市、震荡市  
   - 成交延迟与流动性冲击模拟  

---

## 8. 工作流与落地
1. **研究阶段（Qlib）**：数据管理、特征组切换、模型训练与回测  
2. **策略层**：  
   - 单笔止盈/止损/移动止盈  
   - 长期底仓规则（仅首笔建仓持有）  
   - 仓位上限与现金优先分配  
3. **执行层（长桥 OpenAPI）**  
   - 先模拟盘，再小额实盘  
   - 保证回测与实盘成本模型一致  
4. **运维**  
   - Docker 部署，定时调度  
   - 日志监控 + PnL/仓位/回撤告警  
   - 风控触发 → 自动减仓或暂停策略  

---

## 9. 研究重点
- **特征组消融对比**：基础 / 二级 / 因子及组合  
- **交易信号对比**：方案 A vs 方案 B  
- **模型选优**：6 个候选模型 × 特征组矩阵  
- **长期底仓机制**：验证对风险收益比的影响  
